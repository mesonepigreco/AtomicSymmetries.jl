using AtomicSymmetries
using LinearAlgebra
using Test


# Take two valid nonsymmetrized vectors and matrix.
# Symmetrize them in real space
# Pass in Fourier space
# Then symmetrize again in fourier space
# The two results before and after the symmetrization should match
function test_symmetrize_cartesian_qspace(; verbose=false)
    rs_vector = [1.421321285492716e-20, 2.332728736738343e-20, -1.7899923757851502e-20, 5.2304284492953046e-20, 2.626225652961958e-20, 1.441226559753192e-20, 2.6969529040576923e-20, -1.1214716221646937e-20, -1.3857459017080353e-20, 5.861467994999758e-21, -4.124203420181188e-20, -2.5050999415045932e-20, 2.0536313806180513e-20, 2.8248548790930916e-21, -1.4394398496300774e-20, -4.653599012215126e-20, -1.1750993956377315e-20, -3.023907621697852e-21, -5.331225370018566e-20, 2.690176640479658e-20, 2.081583467877443e-20, -3.903127820947816e-20, 4.997494388800372e-22, 3.505869368685549e-20]
    rs_matrix = [1.1771747018554312e-7 4.413723482651864e-8 -4.699642758472516e-9 -3.3076899079580515e-8 -9.311185253253292e-10 -3.337679275640503e-8 -2.8298486137249535e-8 -5.6926339296753945e-8 1.3642434022581865e-8 -1.9496905900649913e-8 -2.4448849298489174e-8 3.542087037348154e-8 -7.268703267023772e-8 -3.7052792008083416e-9 -1.195465010217294e-8 2.8911957495875557e-8 1.2685871687261686e-8 2.81603811257943e-9 -6.859429374626424e-9 2.0339791974509624e-8 -1.9944250415322337e-8 1.3789325480925137e-8 8.848687833087109e-9 1.80959935237299e-8; 4.413723482651864e-8 9.991170598810226e-8 1.5163036495131564e-8 -6.969648964775731e-9 -4.12906239577911e-8 -1.8041725139383727e-8 -3.0501976764495803e-8 -4.498970106467845e-8 1.3845288233726185e-9 4.244097683201816e-9 2.2950790139306202e-9 1.7117950564178165e-8 -2.723175970040807e-8 -1.3452164826414322e-8 7.68324777840109e-9 2.535359910850957e-8 1.25647497792515e-8 -1.0801703906958109e-8 7.494428373583895e-9 -1.986776354404552e-8 -1.2673910706790919e-8 -1.652597456213426e-8 4.828718611645256e-9 1.6857609204907817e-10; -4.699642758472516e-9 1.5163036495131564e-8 5.581095499634606e-8 2.364368118997148e-9 -9.383709074650181e-9 -1.9828755936775214e-8 -2.8743598844193513e-11 4.169624674229372e-11 5.7629366746662816e-9 -2.364472767590898e-8 8.334703069478464e-9 -3.470816819494629e-8 7.746392910596291e-9 -2.691898830292112e-9 2.519123423711272e-10 3.742320758562731e-9 1.8301941515488011e-9 -9.811840201588795e-9 8.940405364655383e-9 -2.1366441569598326e-9 6.477600828055518e-9 5.579626880414347e-9 -1.1157377900998723e-8 -3.954640508128745e-9; -3.3076899079580515e-8 -6.969648964775731e-9 2.364368118997148e-9 5.7498267269405935e-8 -1.8883273900044056e-8 2.8708913026541767e-9 -1.1702157223133768e-8 6.325466087387977e-9 -7.52728741474142e-9 1.8888545311838794e-8 1.0570061160058841e-9 5.984647470173288e-10 1.2230491549488314e-8 4.710138256732915e-9 2.1847367148201872e-8 -1.8213222466931528e-8 8.557414014751765e-9 -1.912073202169194e-8 2.762747554885565e-9 -2.6021275726484492e-9 1.3830047736446057e-8 -2.8387772915972578e-8 7.805025962589638e-9 -1.4863119616883167e-8; -9.311185253253292e-10 -4.12906239577911e-8 -9.383709074650181e-9 -1.8883273900044056e-8 9.675271690855762e-8 1.8837644136571153e-9 1.8754436579203323e-8 2.935962961128348e-8 8.089171243833565e-9 -1.9780815824648382e-8 -2.852877440281488e-8 -8.374413309704085e-9 -5.223313350318314e-9 -2.6851984872311715e-8 -1.4018370000755422e-8 -1.2286647036601476e-8 -2.1438996228348492e-8 1.1150919213984892e-8 6.468701558812033e-10 1.4750555180091946e-9 9.87970656661779e-10 3.770386190185272e-8 -9.477022576583994e-9 9.664666856972353e-9; -3.337679275640503e-8 -1.8041725139383727e-8 -1.9828755936775214e-8 2.8708913026541767e-9 1.8837644136571153e-9 8.041671626042573e-8 -2.75978747865425e-9 8.515959850804211e-9 -3.423449110260791e-8 1.4059974045044524e-8 1.1377052216045535e-8 -2.0172262906065842e-9 3.0145541704938134e-8 -9.706617942778788e-10 -3.21363875621289e-8 -7.483922838812636e-9 1.4901970661414148e-8 -4.808972251740357e-9 -4.2522264598908195e-9 -2.532384872067182e-9 5.712119360217988e-9 7.963224811257153e-10 -1.5133975336192344e-8 6.8969975232153364e-9; -2.8298486137249535e-8 -3.0501976764495803e-8 -2.8743598844193513e-11 -1.1702157223133768e-8 1.8754436579203323e-8 -2.75978747865425e-9 5.292345612479016e-8 1.9546521659243432e-8 3.5028610239415248e-9 -1.921590805279418e-8 4.037103954963117e-9 -1.24598952247105e-8 1.7978449556592524e-8 1.3937132932409367e-8 5.745989893955582e-9 -1.0671641431648289e-8 -1.9035204566227242e-8 -4.796421094546001e-9 -7.2675255027464616e-9 -4.637767863043368e-9 7.67539965871457e-9 6.253812666189474e-9 -2.1002459320528095e-9 3.120596820143366e-9; -5.6926339296753945e-8 -4.498970106467845e-8 4.169624674229372e-11 6.325466087387977e-9 2.935962961128348e-8 8.515959850804211e-9 1.9546521659243432e-8 8.42560499616509e-8 1.4285438802143085e-8 -1.8087348529877395e-8 -5.117138847083203e-9 -2.6100846823598597e-8 2.883068522515062e-8 -2.1487978381797495e-9 1.1069953935992433e-9 -2.242362712623106e-8 -1.3970215068159741e-8 7.335087660130623e-9 1.2409687521235518e-8 -1.5425806108480935e-8 5.563709772154907e-9 3.032495445984482e-8 -3.196402064635243e-8 -1.0748040901975823e-8; 1.3642434022581865e-8 1.3845288233726185e-9 5.7629366746662816e-9 -7.52728741474142e-9 8.089171243833565e-9 -3.423449110260791e-8 3.5028610239415248e-9 1.4285438802143085e-8 5.858828312208694e-8 -2.7456018044633915e-8 -1.177162870931288e-8 -1.847018156903748e-8 -9.461193497334994e-9 4.529934667570954e-10 3.413823747943483e-9 1.9693963595609875e-10 -1.0072148707386511e-8 1.772343392689467e-8 1.0824888046987485e-8 4.865659727883555e-9 -1.7561559441247722e-8 1.6277376227243298e-8 -7.234014647290564e-9 -1.5222245358698426e-8; -1.9496905900649913e-8 4.244097683201816e-9 -2.364472767590898e-8 1.8888545311838794e-8 -1.9780815824648382e-8 1.4059974045044524e-8 -1.921590805279418e-8 -1.8087348529877395e-8 -2.7456018044633915e-8 9.381364350056555e-8 -1.021210029272398e-8 1.386831617841412e-8 9.605135477949968e-9 4.7939234294023104e-9 1.2671206775527158e-9 6.464671360742939e-9 2.2799328318208004e-8 1.4797993882670603e-8 -1.3141965112104622e-8 -9.274217096868396e-9 1.3444491024871245e-8 -7.691721658554817e-8 2.5517132313305882e-8 -6.337150088010122e-9; -2.4448849298489174e-8 2.2950790139306202e-9 8.334703069478464e-9 1.0570061160058841e-9 -2.852877440281488e-8 1.1377052216045535e-8 4.037103954963117e-9 -5.117138847083203e-9 -1.177162870931288e-8 -1.021210029272398e-8 7.712433564268938e-8 1.6352866645391174e-8 1.3687407572524367e-8 1.5776703031628833e-8 -6.165802869126411e-10 2.140514602763338e-9 -1.7633592778783466e-8 -8.915144172321124e-9 1.2371352839796603e-8 -1.0509696203508756e-8 -1.598746781275647e-8 1.3675645051599752e-9 -3.3406915456058664e-8 1.226199050388192e-9; 3.542087037348154e-8 1.7117950564178165e-8 -3.470816819494629e-8 5.984647470173288e-10 -8.374413309704085e-9 -2.0172262906065842e-9 -1.24598952247105e-8 -2.6100846823598597e-8 -1.847018156903748e-8 1.386831617841412e-8 1.6352866645391174e-8 8.040617477760632e-8 -2.9554013294952816e-8 9.665240522295214e-9 -5.172705757110104e-9 9.640631977124302e-9 5.137115396401549e-9 -1.0434904745020294e-8 -6.119465979882048e-9 -2.096509407893064e-8 -2.712250646929397e-8 -1.1394908776491991e-8 7.167181083967138e-9 1.7519518248408538e-8; -7.268703267023772e-8 -2.723175970040807e-8 7.746392910596291e-9 1.2230491549488314e-8 -5.223313350318314e-9 3.0145541704938134e-8 1.7978449556592524e-8 2.883068522515062e-8 -9.461193497334994e-9 9.605135477949968e-9 1.3687407572524367e-8 -2.9554013294952816e-8 8.131909006443518e-8 3.3319475729915955e-9 -1.0201459147889235e-9 -2.4544551631897932e-8 -1.1812127031171816e-8 -1.8135511612606903e-10 -4.683344869446112e-9 -1.4015852624295536e-8 4.155128628286598e-9 -1.9218237476884036e-8 1.2433012335527115e-8 -1.8303554206181113e-9; -3.7052792008083416e-9 -1.3452164826414322e-8 -2.691898830292112e-9 4.710138256732915e-9 -2.6851984872311715e-8 -9.706617942778788e-10 1.3937132932409367e-8 -2.1487978381797495e-9 4.529934667570954e-10 4.7939234294023104e-9 1.5776703031628833e-8 9.665240522295214e-9 3.3319475729915955e-9 4.7692923378866635e-8 -8.283623636398974e-10 -5.020439030587755e-10 3.0455536025068565e-9 -9.815323548911962e-9 -1.3889584069315105e-9 -2.0100082778252844e-8 7.366844373165472e-9 -2.1176860680737523e-8 -3.962149697843888e-9 -3.178831825095811e-9; -1.195465010217294e-8 7.68324777840109e-9 2.519123423711272e-10 2.1847367148201872e-8 -1.4018370000755422e-8 -3.21363875621289e-8 5.745989893955582e-9 1.1069953935992433e-9 3.413823747943483e-9 1.2671206775527158e-9 -6.165802869126411e-10 -5.172705757110104e-9 -1.0201459147889235e-9 -8.283623636398974e-10 8.577452597359956e-8 -1.1370445149004677e-8 -1.510351335014288e-8 -3.513995239542029e-8 -1.7142738097165543e-9 -5.121170414409583e-9 8.919999424410182e-9 -2.800962744026985e-9 2.6897753243860075e-8 -2.591121577366524e-8; 2.8911957495875557e-8 2.535359910850957e-8 3.742320758562731e-9 -1.8213222466931528e-8 -1.2286647036601476e-8 -7.483922838812636e-9 -1.0671641431648289e-8 -2.242362712623106e-8 1.9693963595609875e-10 6.464671360742939e-9 2.140514602763338e-9 9.640631977124302e-9 -2.4544551631897932e-8 -5.020439030587755e-10 -1.1370445149004677e-8 4.700562732499579e-8 1.4256720809532248e-8 5.878345029694749e-9 -9.608352676432262e-9 7.626139136196504e-10 -7.236098910244573e-9 -1.9344487974704414e-8 -7.301130368533559e-9 6.632229496724006e-9; 1.2685871687261686e-8 1.25647497792515e-8 1.8301941515488011e-9 8.557414014751765e-9 -2.1438996228348492e-8 1.4901970661414148e-8 -1.9035204566227242e-8 -1.3970215068159741e-8 -1.0072148707386511e-8 2.2799328318208004e-8 -1.7633592778783466e-8 5.137115396401549e-9 -1.1812127031171816e-8 3.0455536025068565e-9 -1.510351335014288e-8 1.4256720809532248e-8 6.064168446537259e-8 -1.8221599907380803e-8 -9.516234177402383e-9 -1.6612074368397923e-8 2.1572304247605036e-8 -1.79357690549521e-8 -6.597109403441228e-9 -4.43224920592868e-11; 2.81603811257943e-9 -1.0801703906958109e-8 -9.811840201588795e-9 -1.912073202169194e-8 1.1150919213984892e-8 -4.808972251740357e-9 -4.796421094546001e-9 7.335087660130623e-9 1.772343392689467e-8 1.4797993882670603e-8 -8.915144172321124e-9 -1.0434904745020294e-8 -1.8135511612606903e-10 -9.815323548911962e-9 -3.513995239542029e-8 5.878345029694749e-9 -1.8221599907380803e-8 8.222991062929779e-8 6.9765206011510595e-9 2.7984212367942184e-8 -3.607073825863206e-8 -6.3703893937318646e-9 1.2835522935141685e-9 -3.686936703790555e-9; -6.859429374626424e-9 7.494428373583895e-9 8.940405364655383e-9 2.762747554885565e-9 6.468701558812033e-10 -4.2522264598908195e-9 -7.2675255027464616e-9 1.2409687521235518e-8 1.0824888046987485e-8 -1.3141965112104622e-8 1.2371352839796603e-8 -6.119465979882048e-9 -4.683344869446112e-9 -1.3889584069315105e-9 -1.7142738097165543e-9 -9.608352676432262e-9 -9.516234177402383e-9 6.9765206011510595e-9 3.611975999936408e-8 -9.451377054912604e-9 4.9614271615987954e-9 2.678109981106282e-9 -1.2565769251250795e-8 -1.9617274924903357e-8; 2.0339791974509624e-8 -1.986776354404552e-8 -2.1366441569598326e-9 -2.6021275726484492e-9 1.4750555180091946e-9 -2.532384872067182e-9 -4.637767863043368e-9 -1.5425806108480935e-8 4.865659727883555e-9 -9.274217096868396e-9 -1.0509696203508756e-8 -2.096509407893064e-8 -1.4015852624295536e-8 -2.0100082778252844e-8 -5.121170414409583e-9 7.626139136196504e-10 -1.6612074368397923e-8 2.7984212367942184e-8 -9.451377054912604e-9 8.299339994455239e-8 -1.3165577322423033e-8 1.8878936323638897e-8 -1.953032459875639e-9 1.1070998748964468e-8; -1.9944250415322337e-8 -1.2673910706790919e-8 6.477600828055518e-9 1.3830047736446057e-8 9.87970656661779e-10 5.712119360217988e-9 7.67539965871457e-9 5.563709772154907e-9 -1.7561559441247722e-8 1.3444491024871245e-8 -1.598746781275647e-8 -2.712250646929397e-8 4.155128628286598e-9 7.366844373165472e-9 8.919999424410182e-9 -7.236098910244573e-9 2.1572304247605036e-8 -3.607073825863206e-8 4.9614271615987954e-9 -1.3165577322423033e-8 1.0536229517302927e-7 -1.688614488435011e-8 6.336126792383255e-9 -4.571721061653921e-8; 1.3789325480925137e-8 -1.652597456213426e-8 5.579626880414347e-9 -2.8387772915972578e-8 3.770386190185272e-8 7.963224811257153e-10 6.253812666189474e-9 3.032495445984482e-8 1.6277376227243298e-8 -7.691721658554817e-8 1.3675645051599752e-9 -1.1394908776491991e-8 -1.9218237476884036e-8 -2.1176860680737523e-8 -2.800962744026985e-9 -1.9344487974704414e-8 -1.79357690549521e-8 -6.3703893937318646e-9 2.678109981106282e-9 1.8878936323638897e-8 -1.688614488435011e-8 1.2114646682488795e-7 -3.26367128926724e-8 1.479908020981733e-8; 8.848687833087109e-9 4.828718611645256e-9 -1.1157377900998723e-8 7.805025962589638e-9 -9.477022576583994e-9 -1.5133975336192344e-8 -2.1002459320528095e-9 -3.196402064635243e-8 -7.234014647290564e-9 2.5517132313305882e-8 -3.3406915456058664e-8 7.167181083967138e-9 1.2433012335527115e-8 -3.962149697843888e-9 2.6897753243860075e-8 -7.301130368533559e-9 -6.597109403441228e-9 1.2835522935141685e-9 -1.2565769251250795e-8 -1.953032459875639e-9 6.336126792383255e-9 -3.26367128926724e-8 8.253153162851064e-8 -8.159245529243069e-9; 1.80959935237299e-8 1.6857609204907817e-10 -3.954640508128745e-9 -1.4863119616883167e-8 9.664666856972353e-9 6.8969975232153364e-9 3.120596820143366e-9 -1.0748040901975823e-8 -1.5222245358698426e-8 -6.337150088010122e-9 1.226199050388192e-9 1.7519518248408538e-8 -1.8303554206181113e-9 -3.178831825095811e-9 -2.591121577366524e-8 6.632229496724006e-9 -4.43224920592868e-11 -3.686936703790555e-9 -1.9617274924903357e-8 1.1070998748964468e-8 -4.571721061653921e-8 1.479908020981733e-8 -8.159245529243069e-9 7.007573318919837e-8]

    q_tot = [0.0 -0.08970485720864457 -0.08970485720864457 0.0 -0.08970485720864457 -0.08970485720864457 -0.0 0.0; 0.0 -0.05179112345678227 0.05179112345678227 0.10358224691409373 0.05179112345678227 -0.05179112345678227 -0.10358224691409373 0.0; 0.0 0.07324370920331642 -0.07324370920331642 0.07324370920331642 0.03662185460165821 -0.03662185460165821 0.03662185460165821 -0.10986556380497464]
    itau = [1, 1, 1, 1, 1, 1, 1, 1]
    R_lat = [0.0 2.7869170943386137 2.7869170943386137 5.573834188677228 5.573834188677226 8.36075128301584 8.36075128301584 11.147668377354455; 0.0 1.6090273346255681 4.827082003876703 6.436109338502272 0.0 1.6090273346255681 4.827082003876703 6.436109338502272; 0.0 4.55101655771302 0.0 4.55101655771302 0.0 4.55101655771302 0.0 4.55101655771302]

    unit_cell_structure = zeros(Float64, 3, 1)
    unit_cell = [2.94954603 1.4747730150000002 1.4747730150000002; 0.0 2.554381791611538 0.8514605972038461; 0.0 0.0 2.408294248783948]
    unit_cell .*= 1.889725989

    symmetry_group_uc = get_symmetry_group_from_spglib(unit_cell_structure, unit_cell, [1])

    supercell = unit_cell * 2
    supercell_coords = copy(R_lat)
    supercell_cryst = similar(R_lat)
    reciprocal_supercell = similar(supercell)
    get_reciprocal_lattice!(reciprocal_supercell, supercell) 
    cryst_cart_conv!(supercell_cryst, supercell_coords, supercell, reciprocal_supercell, false; q_space = false)
    symmetry_group_sc = get_symmetry_group_from_spglib(supercell_cryst, supercell, [1, 1, 1, 1, 1, 1, 1, 1])
    translations = get_translations(symmetry_group_sc)

    # Enforce the translations
    apply_translations!(rs_matrix, translations)

    # Get the q points in crystal coordinates
    reciprocal_lattice = zeros(Float64, 3, 3)
    q_points_cryst = zeros(Float64, size(q_tot)...)

    get_reciprocal_lattice!(reciprocal_lattice, unit_cell)
    cryst_cart_conv!(q_points_cryst, q_tot, unit_cell, reciprocal_lattice, false; q_space = true)

    symmetry_group_q = SymmetriesQSpace(symmetry_group_uc, q_points_cryst)

    # Convert the matrix in q space
    nq = size(q_tot, 2)
    q_matrix = zeros(Complex{Float64}, 3, 3, nq)
    matrix_r2q!(q_matrix, rs_matrix, q_tot, itau, R_lat)

    # Convert everything in crystal coordinates
    q_crystal_mat = similar(q_matrix)
    rs_crystal_mat = similar(rs_matrix)
    AtomicSymmetries.cart_cryst_matrix_conversion!(q_crystal_mat,
                                  q_matrix, 
                                  unit_cell;
                                  cart_to_cryst = true)
    AtomicSymmetries.cart_cryst_matrix_conversion!(rs_crystal_mat,
                                  rs_matrix,
                                  supercell;
                                  cart_to_cryst = true)

    # Convert the q points in crystal coordinates
    bg = zeros(Float64, 3, 3)
    get_reciprocal_lattice!(bg, unit_cell)

    q_cryst = similar(q_tot)
    cryst_cart_conv!(q_cryst, q_tot, unit_cell, bg, false; q_space=true)

    # Convert the q matrix in crystal coordinates
    #q_matrix_cryst = similar(q_matrix)
    #AtomicSymmetries.cart_cryst_matrix_conversion!(q_matrix_cryst, q_matrix, unit_cell; cart_to_cryst=true)
    #@show q_matrix_cryst


    # Apply each symmetry and benchmark if the symmetry application is correct
    n_sym = length(symmetry_group_q)
    q_tmp_mat = similar(q_matrix)
    q_target = similar(q_matrix)
    rs_tmp_mat = similar(rs_matrix)
    for i in 1:n_sym
        println("Symmetry $i:")

        q_tmp_mat .= 0
        rs_tmp_mat .= 0

        symmat = symmetry_group_q.symmetries.symmetries[i]
        irt = symmetry_group_q.symmetries.irt[i]
        q_irt = symmetry_group_q.irt_q[i]
        my_irt = symmetry_group_sc.irt[i]

        # My IRT

        # Apply the symmetry
        AtomicSymmetries.apply_symmetry_matrixq!(q_tmp_mat, q_matrix, symmat, irt, q_irt)

        # Apply the symmetry in real space
        AtomicSymmetries.apply_sym_fc!(rs_tmp_mat, rs_matrix, symmat, 3, my_irt)

        # Enforce the translations
        apply_translations!(rs_tmp_mat, translations)


        # Convert to q space
        matrix_r2q!(q_target, rs_tmp_mat, q_tot, itau, R_lat)

        @test isapprox(q_target, q_tmp_mat; rtol = 1e-8, atol = 1e-12)
    end



    # Apply the symmetries
    if verbose
        @show q_matrix
    end

    symmetrize_matrix_cartesian_q!(q_matrix, unit_cell, symmetry_group_q)

    if verbose
        @show q_matrix
    end

    # Perform the symmetrization in real space
    symmetrize_fc!(rs_matrix, supercell, symmetry_group_sc)

    matrix_r2q!(q_target, rs_matrix, q_tot, itau, R_lat)
    if verbose
        @show q_target
    end

    @test isapprox(q_target, q_matrix; rtol = 1e-8, atol = 1e-12)
end


if abspath(PROGRAM_FILE) == @__FILE__
    test_symmetrize_cartesian_qspace(; verbose=true)
end
