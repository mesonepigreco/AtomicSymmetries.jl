using AtomicSymmetries
using LinearAlgebra
using Test

if abspath(PROGRAM_FILE) == @__FILE__
    include("define_cell.jl")
end


function test_filter(; verbose=false)
    positions, cell, types = get_pm3m_perovskite()
    symmetry_group = get_symmetry_group_from_spglib(positions, cell, types)

    n_before_filter = length(symmetry_group)
    if verbose
        println("Number of original symmetries: ", get_nsymmetries(symmetry_group))
    end

    # Now filter the symmetries
    filter_invariant_symmetries!(symmetry_group, [1.0, 0.0, 0.0], cell)

    n_after_filter = length(symmetry_group)

    if verbose
        println("Number of symmetries after filter: ", get_nsymmetries(symmetry_group))
    end

    # Try extending the symmetry group
    complete_symmetry_group!(symmetry_group)

    n_after_complete = length(symmetry_group)

    if verbose
        println("Number of symmetries after complete: ", get_nsymmetries(symmetry_group))
    end

    @test n_before_filter > n_after_filter
    @test n_after_filter == n_after_complete
    @test n_after_complete == 8

    # Check that the inversion is not in the symmetry group
    for i in 1:length(symmetry_group)
        sym = symmetry_group.symmetries[i]
        if verbose
            println("Symmetry $i: ", sym)
        end
        @test max(abs.(sym .+ I(3))...) > 1e-12
    end
end

function test_filter_full_vector(; verbose=false)
    positions, cell, types = get_pm3m_perovskite()
    symmetry_group = get_symmetry_group_from_spglib(positions, cell, types)

    n_before_filter = length(symmetry_group)
    if verbose
        println("Number of original symmetries: ", get_nsymmetries(symmetry_group))
    end

    # Now filter the symmetries
    vector_filter = [0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]
    filter_invariant_symmetries!(symmetry_group, vector_filter, cell)

    n_after_filter = length(symmetry_group)

    if verbose
        println("Number of symmetries after filter: ", get_nsymmetries(symmetry_group))
    end

    # Try extending the symmetry group
    complete_symmetry_group!(symmetry_group)

    n_after_complete = length(symmetry_group)

    if verbose
        println("Number of symmetries after complete: ", get_nsymmetries(symmetry_group))
    end

    @test n_before_filter > n_after_filter
    @test n_after_filter == n_after_complete

    @test n_after_complete == 8

    # Check that the inversion is not in the symmetry group
    for i in 1:length(symmetry_group)
        sym = symmetry_group.symmetries[i]
        if verbose
            println("Symmetry $i: ", sym)
        end
        @test max(abs.(sym .+ I(3))...) > 1e-12
    end

end


function test_filter_fourier(; verbose=false)

    crystal = [0.24999999993864644 0.7499999997750333 0.4999999998363888 1.4275981037686521e-15 0.7848500134240198 0.7151499863177254 0.24999999980568324 0.2848500133550514 0.7499999998670944 0.21514998624875617; 0.24999999993864633 0.7499999997750336 0.4999999998363899 1.4517398414650017e-15 0.7151499859777861 0.24999999974197842 0.7848500136284202 0.7499999999307985 0.2151499860443564 0.2848500136949918; 0.24999999993864594 0.7499999997750352 0.49999999983638915 5.217765912568204e-16 0.2500000000460021 0.784850013388103 0.7151499860137032 0.21514998628467352 0.2848500136590736 0.7499999996267762]
    cell = [5.134582577861894 -5.134582577861894 -0.0; 2.964452636934994 2.964452636934994 -5.928905273869984; 8.356586973319539 8.356586973319539 8.35658697331953]
    types = [0, 0, 1, 1, 2, 2, 2, 2, 2, 2]
    q_points = [0.0 0.25000000000043476 -0.25000000000043476 0.5000000000005667 0.2500000000003225 -0.2500000000003225 -0.5000000000005667 0.2499999999997863 -0.2499999999997863 -0.25000000000047745 0.2500000000000108 -0.2500000000000108 0.25000000000047745 0.2500000000000818 -0.2500000000000818 -5.007105841059456e-14 0.25000000000019407 -0.25000000000019407 5.007105841059456e-14 0.24999999999979852 -0.5000000000000426 0.5000000000000426 0.4999999999999304 -0.24999999999979852 -0.4999999999999304 0.24999999999996952 -0.5000000000002136 -0.25000000000018197 -0.24999999999996952 0.5000000000002136 0.25000000000018197 0.2499999999997363 -0.49999999999998046 -2.833566714599556e-13 0.5000000000000927 -0.24999999999996078 3.956002192495589e-13 -0.2499999999997363 0.49999999999998046 2.833566714599556e-13 -0.5000000000000927 0.24999999999996078 -3.956002192495589e-13 0.25000000000024414 -1.1224354778960333e-13 -0.2500000000001319 -0.25000000000024414 1.1224354778960333e-13 0.2500000000001319 0.24999999999989855 3.455846719901956e-13 -3.455846719901956e-13 -2.3331336862497665e-13 -0.24999999999989855 2.3331336862497665e-13 -0.4999999999996971 0.5000000000004544 1.9062529332813938e-13 0.5000000000006789 -0.500000000000326 -1.6234236177581352e-13 -6.217248937900877e-14 -0.24999999999984854 0.24999999999984854; 0.0 0.25000000000043476 -0.25000000000043476 0.2500000000003225 0.5000000000005667 -0.5000000000005667 -0.2500000000003225 0.2499999999997863 -0.2499999999997863 0.2500000000000108 -0.25000000000047745 0.25000000000047745 -0.2500000000000108 0.2500000000000818 -0.2500000000000818 0.25000000000019407 -5.007105841059456e-14 5.007105841059456e-14 -0.25000000000019407 0.5000000000000426 -0.24999999999979852 0.24999999999979852 0.4999999999999304 -0.5000000000000426 -0.4999999999999304 0.5000000000002136 -0.24999999999996952 0.2500000000003063 -0.5000000000002136 0.24999999999996952 -0.2500000000003063 0.49999999999998046 -0.2499999999997363 0.24999999999996078 -3.956002192495589e-13 2.833566714599556e-13 -0.5000000000000927 -0.49999999999998046 0.2499999999997363 -0.24999999999996078 3.956002192495589e-13 -2.833566714599556e-13 0.5000000000000927 -0.25000000000024414 0.2500000000001319 1.1224354778960333e-13 0.25000000000024414 -0.2500000000001319 -1.1224354778960333e-13 -3.455846719901956e-13 -0.24999999999989855 0.24999999999989855 -2.3331336862497665e-13 3.455846719901956e-13 2.3331336862497665e-13 -0.4999999999996971 0.5000000000004544 0.5000000000006789 1.9062529332813938e-13 1.6234236177581352e-13 0.500000000000326 -6.217248937900877e-14 -0.24999999999984854 0.24999999999984854; 0.0 0.5000000000001631 -0.5000000000001631 0.2500000000001437 0.2500000000001437 -0.2500000000001437 -0.2500000000001437 -0.25000000000054357 0.25000000000054357 0.2499999999994953 0.2499999999994953 -0.2499999999994953 -0.2499999999994953 3.5293989952833726e-13 -3.5293989952833726e-13 0.25000000000037237 0.25000000000037237 -0.25000000000037237 -0.25000000000037237 0.5000000000002207 -0.5000000000002207 0.5000000000002207 0.2500000000002013 -0.5000000000002207 -0.2500000000002013 -0.24999999999966652 0.24999999999966652 0.5000000000003918 0.24999999999966652 -0.24999999999966652 -0.5000000000003918 -1.711686348215835e-13 1.711686348215835e-13 0.49999999999986766 0.24999999999984826 -0.49999999999986766 -0.24999999999984826 1.711686348215835e-13 -1.711686348215835e-13 -0.49999999999986766 -0.24999999999984826 0.49999999999986766 0.24999999999984826 0.0 -0.25000000000001943 0.25000000000001943 0.0 0.25000000000001943 -0.25000000000001943 -5.241085343499208e-13 5.241085343499208e-13 -5.241085343499208e-13 0.2499999999994953 5.241085343499208e-13 -0.2499999999994953 -0.4999999999996965 1.2423395645555502e-13 0.5000000000001631 0.5000000000001631 -3.5293989952833726e-13 3.5293989952833726e-13 -0.5000000000003918 -0.24999999999984826 0.24999999999984826]
    polarization_vector = [1.0, 0.0, 0.0]
 
    # Compute the symmetry group
    symmetry_group = get_symmetry_group_from_spglib(crystal, cell, types)

    # Convert the symmetry group in q space = 
    q_symmetry_group = SymmetriesQSpace(symmetry_group, q_points)

    # Filter the invariant symmetries
    filter_invariant_symmetries!(q_symmetry_group, polarization_vector, cell)
end

if abspath(PROGRAM_FILE) == @__FILE__
    test_filter(verbose=true)
    test_filter_full_vector(verbose=true)
    test_filter_fourier(; verbose=true)
end

